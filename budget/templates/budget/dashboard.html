{% extends 'budget/base.html' %}
{% load budget_extras %}
{% load static %}

{% block extrastyle %}{{ block.super }}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block title %}Dashboard - Budget Tracker{% endblock %}

{% block content %}
<div class="row">
    <!-- Monthly Summary (Pie Chart) -->
    <div class="col-md-4">
        <div class="card custom-card mb-4">
            <div class="card-header custom-card-header-skyblue custom-card-header-border">
                <h5 class="card-title custom-text-blk mb-0">Monthly Summary</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="monthlySummaryChart"></canvas>
                </div>
                <div class="mt-3">
                    <div class="mb-2">
                        <h6>Income</h6>
                        <p class="text-success">${{ income|floatformat:2 }}</p>
                    </div>
                    <div class="mb-2">
                        <h6>Expenses</h6>
                        <p class="text-danger">${{ expenses|floatformat:2 }}</p>
                    </div>
                    <div>
                        <h6>Balance</h6>
                        <p class="{% if balance >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ balance|floatformat:2 }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Expenses (Bar Chart) -->
    <div class="col-md-8">
        <div class="card custom-card mb-4">
            <div class="card-header custom-card-header-lightskyblue custom-card-header-border">
                <h5 class="card-title custom-text-blk mb-0">Category Expenses</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="categoryExpensesChart"></canvas>
                </div>
                <div class="table-responsive mt-3">
                    <table class="table custom-no-bg">
                        <thead>
                            <tr class="custom-text-align-center">
                                <th class="custom-col-name-skyblue">Category</th>
                                <th class="custom-col-name-skyblue">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in category_expenses %}
                            <tr class="custom-text-align-center">
                                <td>{{ expense.category__name }}</td>
                                <td>${{ expense.total|floatformat:2 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-center">No expenses recorded for this month.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Budgets Table -->
<div class="row">
    <div class="col-12">
        <div class="card custom-card">
            <div class="card-header d-flex justify-content-between align-items-center custom-card-header-purple custom-card-header-border">
                <h5 class="card-title custom-text-blk mb-0">Monthly Budgets</h5>
                <a href="{% url 'budget:budget-create' %}" class="btn btn-primary btn-sm custom-btn-purple">+ Add Budget</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table custom-no-bg">
                        <thead>
                            <tr class="custom-text-align-center">
                                <th class="custom-col-name-purple">Category</th>
                                <th class="custom-col-name-purple">Budget Amount</th>
                                <th class="custom-col-name-purple">Spent Amount</th>
                                <th class="custom-col-name-purple">Remaining</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for budget in budgets %}
                            {% with spent=budget_spent|get_item:budget.category.id|default:0 %}
                            <tr class="custom-text-align-center">
                                <td>{{ budget.category.name }}</td>
                                <td>${{ budget.amount|floatformat:2 }}</td>
                                <td>${{ spent|floatformat:2 }}</td>
                                <td class="{% if budget.amount >= spent %}text-success{% else %}text-danger{% endif %}">
                                    ${{ budget.amount|sub:spent|floatformat:2 }}
                                </td>
                            </tr>
                            {% endwith %}
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">No budgets set for this month.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% if settings.DEBUG %}
<!-- Debug information (only visible in DEBUG mode) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning">
                <h5 class="card-title">Debug Information</h5>
            </div>
            <div class="card-body">
                <div id="chart-debug">
                    <p><strong>Chart Data:</strong></p>
                    <p>Income: {{ income }}</p>
                    <p>Expenses: {{ expenses }}</p>
                    <p>Category Names: {{ category_names|safe }}</p>
                    <p>Category Values: {{ category_values|safe }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Store data for charts in JSON format -->
{{ category_names|json_script:"category-names" }}
{{ category_values|json_script:"category-values" }}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
console.log("Initializing charts..."); // Debug log
document.addEventListener('DOMContentLoaded', function() {
    console.log("Chart initialization starting"); // Debug log

    // ----- Monthly Summary Pie Chart -----
    const monthlySummaryCanvas = document.getElementById('monthlySummaryChart');
    if (!monthlySummaryCanvas) {
        console.error("Could not find monthlySummaryChart canvas element");
        return;
    }

    const monthlySummaryCtx = monthlySummaryCanvas.getContext('2d');

    // Get financial data with proper error handling
    const income = parseFloat('{{ income|default:0 }}') || 0;
    const expenses = parseFloat('{{ expenses|default:0 }}') || 0;
    const balance = parseFloat('{{ balance|default:0 }}') || 0;

    console.log("Financial data:", { income, expenses, balance }); // Debug log

    // Make sure there's data to display
    if (income === 0 && expenses === 0 && balance === 0) {
        // Show a message in the canvas if there's no data
        monthlySummaryCtx.font = '14px Arial';
        monthlySummaryCtx.fillStyle = '#666';
        monthlySummaryCtx.textAlign = 'center';
        monthlySummaryCtx.fillText('No financial data available for this month', monthlySummaryCanvas.width / 2, monthlySummaryCanvas.height / 2);
    } else {
        // Create pie chart
        new Chart(monthlySummaryCtx, {
            type: 'pie',
            data: {
                labels: ['Income', 'Expenses', balance >= 0 ? 'Balance' : 'Deficit'],
                datasets: [{
                    data: [
                        income || 0.01, // Use small value if 0 to avoid Chart.js errors
                        expenses || 0.01,
                        Math.abs(balance) || 0.01
                    ],
                    backgroundColor: [
                        'rgba(187, 219, 155, 0.7)',  // Green for income
                        'rgba(235, 111, 128, 0.7)',  // Red for expenses
                        balance >= 0 ? 'rgba(155, 186, 232, 0.7)' : 'rgba(255, 193, 7, 0.7)'  // Blue/Yellow for balance
                    ],
                    borderColor: [
                        'rgba(187, 219, 155, 1)',
                        'rgba(235, 111, 128, 1)',
                        balance >= 0 ? 'rgba(155, 186, 232, 1)' : 'rgba(255, 193, 7, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '$' + parseFloat(context.raw).toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }

    // ----- Category Expenses Bar Chart -----
    const categoryCanvas = document.getElementById('categoryExpensesChart');
    if (!categoryCanvas) {
        console.error("Could not find categoryExpensesChart canvas element");
        return;
    }

    const categoryCtx = categoryCanvas.getContext('2d');

    try {
        // Get category data from JSON script tags with error handling
        const categoryNamesElement = document.getElementById('category-names');
        const categoryValuesElement = document.getElementById('category-values');

        if (!categoryNamesElement || !categoryValuesElement) {
            console.error("Could not find category data elements");
            return;
        }

        const categoryNames = JSON.parse(categoryNamesElement.textContent || '[]');
        const categoryValues = JSON.parse(categoryValuesElement.textContent || '[]');

        console.log("Category data:", { categoryNames, categoryValues }); // Debug log

        // Check if there's data to display
        if (categoryNames.length === 0 || categoryValues.length === 0) {
            // Show a message in the canvas if there's no data
            categoryCtx.font = '14px Arial';
            categoryCtx.fillStyle = '#666';
            categoryCtx.textAlign = 'center';
            categoryCtx.fillText('No category expense data available for this month', categoryCanvas.width / 2, categoryCanvas.height / 2);
        } else {
            // Create bar chart
            new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: categoryNames,
                    datasets: [{
                        label: 'Amount ($)',
                        data: categoryValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + parseFloat(context.raw).toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error("Error initializing category chart:", error);
        // Show error message in the canvas
        categoryCtx.font = '14px Arial';
        categoryCtx.fillStyle = '#d9534f';
        categoryCtx.textAlign = 'center';
        categoryCtx.fillText('Error loading chart data', categoryCanvas.width / 2, categoryCanvas.height / 2);
    }
});
</script>
{% endblock %}